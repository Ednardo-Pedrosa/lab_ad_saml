Vagrant.configure("2") do |config|

  # AD - Windows Server
  config.vm.define "ad" do |ad|
    ad.vm.box = "StefanScherer/windows_2022"
    ad.vm.hostname = "SRVAD01"
    ad.vm.communicator = "winrm"
    ad.winrm.username = "vagrant"
    ad.winrm.password = "vagrant"

    ad.vm.network "public_network",
      ip: "192.168.3.145",
      bridge: "enp1s0"

    ad.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus = 1
      vb.gui = true
    end

# Configurar WinRM
  ad.vm.provision "shell", privileged: true, inline: <<-SHELL
    winrm quickconfig -q
    winrm set winrm/config '@{MaxTimeoutms="1800000"}'
    winrm set winrm/config/service '@{AllowUnencrypted="true"}'
    winrm set winrm/config/service/auth '@{Basic="true"}'
    netsh advfirewall firewall add rule name="Allow WinRM" dir=in action=allow protocol=TCP localport=5985
  SHELL

  # Configurar AD
  ad.vm.provision "shell", privileged: true, path: "scripts/setup-ad.ps1"

  # Reiniciar após configurar o domínio
  ad.vm.provision "shell", privileged: true, inline: "Restart-Computer -Force"

  # Criar usuários após reinicialização
  ad.vm.provision "shell", privileged: true, path: "scripts/create-users.ps1"
end

  # Keycloak - Ubuntu Server
  config.vm.define "keycloak" do |keycloak|
    keycloak.vm.box = "ubuntu/bionic64"
    keycloak.vm.hostname = "keycloak"
    keycloak.vm.network "public_network",
      ip: "192.168.3.146",
      bridge: "enp1s0"

    keycloak.vm.provider "virtualbox" do |vb|
      vb.memory = 512
      vb.cpus = 1
    end

keycloak.vm.provision "shell", inline: <<-SHELL
  # Atualizar pacotes
  apt-get update

  # Instalar dependências básicas
  apt-get install -y apt-transport-https ca-certificates curl software-properties-common xmlsec1

  # Adicionar repositório oficial do Docker
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
  add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"

  # Atualizar novamente após adicionar o repositório
  apt-get update

  # Instalar Docker
  apt-get install -y docker-ce docker-ce-cli containerd.io

  # Adicionar usuário vagrant ao grupo docker
  usermod -aG docker vagrant

  # Habilitar e iniciar o serviço Docker
  systemctl enable docker
  systemctl start docker

  # Instalar Docker Compose (versão standalone)
  curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose

  # Verificar instalações
  docker --version
  docker-compose --version

  # Criar diretório para Keycloak
  mkdir -p /opt/keycloak

  # Criar docker-compose.yml
  cat > /opt/keycloak/docker-compose.yml <<EOF
version: '3'
services:
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.2
    container_name: keycloak
    command: start-dev
    ports:
      - "8086:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
EOF

  # Executar Keycloak
  cd /opt/keycloak
  docker-compose up -d

  # Verificar logs do contêiner
  sleep 10
  docker logs keycloak
SHELL

  end

end
